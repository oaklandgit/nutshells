#!/usr/bin/env nu

# Public key available from https://www.bart.gov/schedules/developers/api
# Stations can be fetched from this API: https://api.bart.gov/docs/stn/stns.aspx
# Directions for all trains are 'North' or 'South'

let api_key = $env.BART_API_KEY
let station = 'ROCK'
let direction = 'South'
let msg = $"Next ($direction)bound trains from ($station):"

print $msg

http get $"https://api.bart.gov/api/etd.aspx?cmd=etd&orig=($station)&key=($api_key)&json=y"
| $in.root.station
| first
| $in.etd.estimate
| flatten
| where direction == ($direction) 
| insert bikes {|row| if (($row.bikeflag | str trim | into int) == 1) { "Yes" } else { "No" } }
| insert time {|row| 
    let mins = if ($row.minutes == "Leaving") { 
        0 
    } else { 
        $row.minutes | into int 
    }
    (date now) + ($mins * 1min) | format date "%H:%M"
  }
| select minutes time length bikes
| table --index false
